#!/vendor/bin/sh

vendor=$(/vendor/bin/getprop ro.boot.fp)
FP_CBTEST_LOGCAT_LOG="/data/system/fingerprint/FP_CHECKERBOARDTEST_LOGCAT_FQC.log"
FP_CBTEST_KERNEL_LOG="/data/system/fingerprint/FP_CHECKERBOARDTEST_KERNEL_FQC.log"
FP_AUTOTEST_LOG="/data/system/fingerprint/elan_fp_autotest_fqc.log"
FP_CHECKERBOARDTEST="/data/system/fingerprint/elan_fp_checkerboardtest_fqc.log"
parameter_1=$(/vendor/bin/getprop vendor.sys.fqcfingerprint)
/vendor/bin/setprop vendor.sys.fqcfpret 0
/vendor/bin/setprop vendor.sys.fqcfpend 0
goodix_cmd="gf_cmd_test_"$vendor
fpc_cmd="fpc_tee_test"

fingerprint_selftest() {
	logcat -v time -b all >> $FP_CBTEST_LOGCAT_LOG 2>&1 &

	if [ "${vendor:0:4}" = "gxfp" ]; then
		case "$parameter_1" in
			"1")
				echo "FPM self test"
				$goodix_cmd 1 > /dev/null
				ret=$?
				;;
			"2")
				echo "FPM touch test"
				$goodix_cmd 2 > /dev/null
				ret=$?
				;;
			"3")
				echo "FPM SNR test"
				$goodix_cmd 3 > /dev/null
				ret=$?
				;;
			"4")
				echo "FPM Image Quality test"
				$goodix_cmd 4 > /dev/null
				ret=$?
				;;
			*)
				echo "just test"
				$goodix_cmd > /dev/null
				ret=$?
				;;
		esac
	elif [ "$vendor" = "fpc1035_roo" ]; then
		case "$parameter_1" in
			"1")
				echo "FPC self test"
				$fpc_cmd -s > /dev/null
				ret=$?
				if [ ret -eq 0 ]; then
					echo "FPC self test Success"
					ret=1
				else
					echo "FPC self test Fail"
					ret=0
				fi
				;;
			"4")
				echo "FPC Image Quality test"
				$fpc_cmd -f > /dev/null
				ret=$?
				if [ ret -eq 0 ]; then
					echo "FPC Image Quality Success"
					ret=1
				else
					echo "FPC Image Quality Fail"
					ret=0
				fi
				;;
			*)
				echo "just test"
				$fpc_cmd > /dev/null
				ret=$?
				;;
		esac
	elif [ "$vendor" = "enfp680rc_pda" ]; then
		case "$parameter_1" in
			"1")
				echo "ELAN_Self_Test......"
				/vendor/bin/echo "" > /data/system/fingerprint/FactoryInfo.txt
				/vendor/bin/chmod 644 /data/system/fingerprint/*

				/vendor/bin/echo "" > /data/system/users/0/fpdata/testinfo.txt
				/vendor/bin/chown system.system /data/system/users/0/fpdata/testinfo.txt
				/vendor/bin/chmod 644 /data/system/users/0/fpdata/testinfo.txt

				/vendor/bin/echo "" > /data/system/users/0/fpdata/testcase.txt
				/vendor/bin/chown system.system /data/system/users/0/fpdata/testcase.txt
				/vendor/bin/chmod 644 /data/system/users/0/fpdata/testcase.txt

				/vendor/bin/ElanPrintf test_tool interface > $FP_AUTOTEST_LOG
				spi_rst_test=$?
				/vendor/bin/ElanPrintf test_tool cal 800 14200 > $FP_CHECKERBOARDTEST
				openshort_test=$?
				echo "ELAN_Self_Test_Result: spi_rst_test = $spi_rst_test, openshort_test = $openshort_test"
				/vendor/bin/dmesg > $FP_CBTEST_KERNEL_LOG &

				if [ $spi_rst_test -eq 0 ] && [ $openshort_test -eq 0 ]; then
					echo "Self_Test_Pass"
					echo "OpenShort_Pass"
					echo "SMT_Tests_all_Success"
					ret=1
				else
					echo "OpenShort Fail"
					echo "Self Test Fail"
					echo "SMT Tests all Fail"
					ret=0
				fi
				;;
			"2")
				echo "ELAN_Interface_Test......"
				/vendor/bin/echo "" > /data/system/fingerprint/FactoryInfo.txt
				/vendor/bin/chmod 644 /data/system/fingerprint/*

				/vendor/bin/echo "" > /data/system/users/0/fpdata/testinfo.txt
				/vendor/bin/chown system.system /data/system/users/0/fpdata/testinfo.txt
				/vendor/bin/chmod 644 /data/system/users/0/fpdata/testinfo.txt

				/vendor/bin/echo "" > /data/system/users/0/fpdata/testcase.txt
				/vendor/bin/chown system.system /data/system/users/0/fpdata/testcase.txt
				/vendor/bin/chmod 644 /data/system/users/0/fpdata/testcase.txt

				/vendor/bin/ElanPrintf test_tool interface > $FP_AUTOTEST_LOG
				spi_rst_test=$?
				echo "ELAN_Interface_Test_Result: $spi_rst_test"

				if [ $spi_rst_test -eq 0 ]; then
					echo "ELAN_Interface_Test_Success"
					ret=1
				else
					echo "ELAN_Interface_Test_Fail"
					ret=0
				fi
				;;
			"3")
				echo "ELAN_Calibration_Test......"
				/vendor/bin/echo "" > /data/system/fingerprint/FactoryInfo.txt
				/vendor/bin/chmod 644 /data/system/fingerprint/*

				/vendor/bin/echo "" > /data/system/users/0/fpdata/testinfo.txt
				/vendor/bin/chown system.system /data/system/users/0/fpdata/testinfo.txt
				/vendor/bin/chmod 644 /data/system/users/0/fpdata/testinfo.txt

				/vendor/bin/echo "" > /data/system/users/0/fpdata/testcase.txt
				/vendor/bin/chown system.system /data/system/users/0/fpdata/testcase.txt
				/vendor/bin/chmod 644 /data/system/users/0/fpdata/testcase.txt

				/vendor/bin/ElanPrintf test_tool cal 800 14200 > $FP_CHECKERBOARDTEST
				openshort_test=$?
				echo "ELAN_Calibration_Test_Result: $openshort_test"

				if [ $openshort_test -eq 0 ]; then
					echo "ELAN_Calibration_Test_Success"
					ret=1
				else
					echo "ELAN_Calibration_Test_Fail"
					ret=0
				fi
				;;
		esac
	else
		ret=0
	fi

	echo "ret=$ret"
	/vendor/bin/setprop vendor.sys.fqcfpend 1
	/vendor/bin/setprop vendor.sys.fqcfpret $ret
}

fingerprint_selftest
